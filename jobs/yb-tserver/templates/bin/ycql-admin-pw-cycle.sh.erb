#!/usr/bin/env bash

set -eu

source /var/vcap/packages/python-*/bosh/runtime.env

echo "attempting cassandra admin user password cycle..."

<% p("ycql.old_cassandra_passwords", []).each do |old_password_attempt| %>

OLD_PASSWORD_ATTEMPT="<%= old_password_attempt %>"
NEW_PASSWORD="<%= p('ycql.cassandra_password') %>"

/var/vcap/packages/yugabyte/bin/cqlsh \
  --cqlshrc /var/vcap/jobs/yb-tserver/config/cqlshrc \
  --password "${OLD_PASSWORD_ATTEMPT}" \
  --execute "ALTER ROLE cassandra WITH password = '${NEW_PASSWORD}'" \
  --debug

<% end %>

#!/usr/bin/env bash

set -u

source /var/vcap/packages/python-*/bosh/runtime.env

echo "attempting cassandra admin user password cycle..."

<% if p("ycql.old_cassandra_passwords").length == 1 && p("ycql.old_cassandra_passwords")[0] == p('ycql.cassandra_password') %>
echo "appears old_cassandra_passwords only has one element, and it's the same value as the intended password. aborting early to save time."
exit 0
<% end %>

<% p("ycql.old_cassandra_passwords", []).each_with_index do |old_password_attempt, index| %>

echo "attempting to update current password using old_cassandra_password at list index <%= index %>..."

/var/vcap/packages/yugabyte/bin/cqlsh \
  --cqlshrc /var/vcap/jobs/yb-tserver/config/cqlshrc \
  --password "<%= old_password_attempt %>" \
  --execute "ALTER ROLE cassandra WITH password = <%= p('ycql.cassandra_password') %>'"

failure_on_attempt=$?
if [[ "${failure_on_attempt}" == 0 ]]; then

  echo "password appears to have been set, confirming..."

  /var/vcap/packages/yugabyte/bin/cqlsh \
    --cqlshrc /var/vcap/jobs/yb-tserver/config/cqlshrc \
    --execute "ALTER ROLE cassandra WITH password = <%= p('ycql.cassandra_password') %>'"

  failure_on_confirmation=$?
  if [[ "${failure_on_confirmation}" == 0 ]]; then
    echo "set password appears CONSISTENT with intended password set in cqlshrc. success."
    exit 0
  fi

  echo "set password appears INCONSISTENT with intended password set in cqlshrc. aborting."
  exit 1

fi

echo "appears old_cassandra_password at list index <%= index %> was invalid, continuing..."

<% end %>

#!/usr/bin/env bash

set -eux

echo "copying compile.env..."
mkdir ${BOSH_INSTALL_TARGET}/bosh
cp python-pkg/runtime.env ${BOSH_INSTALL_TARGET}/bosh/runtime.env
cp python-pkg/compile.env ${BOSH_INSTALL_TARGET}/bosh/compile.env

echo "extracting python..."
tar xzvf python/Python-*.tgz

echo "building python..."
pushd Python-*
./configure --prefix=${BOSH_INSTALL_TARGET}
make
make install
popd

echo "extracting setuptools..."
unzip python/setuptools-*.zip

echo "creating the setuptools site packages..."
mkdir -p ${BOSH_INSTALL_TARGET}/lib/python*/site-packages

echo "setting the PYTHONPATH with setuptools site packages..."
export PYTHONPATH=$(ls -d ${BOSH_INSTALL_TARGET}/lib/python*/site-packages)

echo "installing setuptools..."
pushd setuptools-*
${BOSH_INSTALL_TARGET}/bin/python3 setup.py install --prefix=${BOSH_INSTALL_TARGET}
popd

echo "extracting pip..."
tar xzvf python/pip-*.tar.gz

echo "creating the pip site packages..."
mkdir -p ${BOSH_INSTALL_TARGET}/lib/python*/site-packages

echo "setting the PYTHONPATH with setuptools and pip site packages..."
export PYTHONPATH=$(ls -d ${BOSH_INSTALL_TARGET}/lib/python*/site-packages):${PYTHONPATH}

echo "installing pip..."
pushd pip-*
${BOSH_INSTALL_TARGET}/bin/python3 setup.py install --prefix=${BOSH_INSTALL_TARGET}
popd
